# name: CI — OS + Python matrix

# on:
#   push:
#   pull_request:

# jobs:
#   build:
#     name: Build (${{ matrix.os }} — py${{ matrix.python-version }})
#     strategy:
#       matrix:
#         python-version: ["3.10", "3.11"]   
#         os: [ubuntu-latest, windows-latest]
#       fail-fast: false                     # allow full matrix to complete for diagnostics
#       max-parallel: 4                      # optional: limit concurrency
#     uses: ./.github/workflows/python-build.yml
#     with:
#       python-version: ${{ matrix.python-version }}
#       runner-os: ${{ matrix.os }}

#     # Each matrix entry will call the reusable workflow with its python-version.

#   # E2E job: runs once after all matrix build runs succeed
#   e2e:
#     needs: build                # waits for ALL matrix build runs to finish successfully
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
#         # every job gets its own runner; checkout again

#       - name: Set up Python for E2E
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       - name: Install deps for E2E
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt

#       - name: Run E2E tests
#         run: pytest tests/e2e -q

#####################



name: Flaky Test Collector

on:
  push:
  pull_request:

jobs:
  flaky:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run flaky test (inline) but continue on error
        continue-on-error: true
        run: |
          # Run a tiny flaky test inline (no separate file needed).
          # If it exits non-zero, capture its exit code to flaky.exit.
          python - <<'PY' || echo $? > flaky.exit
          import random, sys
          if random.random() < 0.6:
              print("Flaky test passed")
              sys.exit(0)
          else:
              print("Flaky test failed")
              sys.exit(1)
          PY

      - name: Report flaky outcome
        run: |
          if [ -f flaky.exit ]; then
            echo "Flaky test failed with code $(cat flaky.exit)"
            exit 0
          else
            echo "Flaky test passed"
          fi